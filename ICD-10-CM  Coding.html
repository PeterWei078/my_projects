<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>內科醫學編碼互動式平台 (ICD-10-CM)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons (Pinned Version for Stability) -->
    <script src="https://unpkg.com/lucide@0.263.1"></script>

    <style>
        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: #f8fafc;
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Icon Helper using Lucide Global ---
        // 這是為了在沒有 Webpack/Build Step 的情況下動態渲染 Lucide 圖示
        const LucideIcon = ({ name, size = 24, className = "" }) => {
            // 獲取全局 lucide 對象中的圖示定義
            const iconDef = window.lucide && window.lucide.icons ? window.lucide.icons[name] : null;
            
            // 安全檢查：確認 iconDef 存在且為陣列結構 (Lucide v0.263.1 標準結構: [tag, attrs, children])
            if (!iconDef || !Array.isArray(iconDef)) {
                console.warn(`Icon ${name} not found or invalid format`);
                return null;
            }

            // Lucide icons 結構: [tag, attrs, children]
            const [tag, attrs, children] = iconDef;

            // 安全檢查：確認 children 存在
            if (!children) return null;

            const childElements = children.map((child, index) => {
                const [childTag, childAttrs] = child;
                return React.createElement(childTag, { ...childAttrs, key: index });
            });

            return React.createElement(
                tag,
                {
                    ...attrs,
                    width: size,
                    height: size,
                    className: `lucide lucide-${name.toLowerCase()} ${className}`,
                    strokeWidth: 2
                },
                childElements
            );
        };

        // 建立 App 中使用的所有圖示組件
        const Stethoscope = (props) => <LucideIcon name="Stethoscope" {...props} />;
        const Search = (props) => <LucideIcon name="Search" {...props} />;
        const ArrowRight = (props) => <LucideIcon name="ArrowRight" {...props} />;
        const FileText = (props) => <LucideIcon name="FileText" {...props} />;
        const CheckCircle = (props) => <LucideIcon name="CheckCircle" {...props} />;
        const AlertTriangle = (props) => <LucideIcon name="AlertTriangle" {...props} />;
        const Copy = (props) => <LucideIcon name="Copy" {...props} />;
        const Trash2 = (props) => <LucideIcon name="Trash2" {...props} />;
        const Database = (props) => <LucideIcon name="Database" {...props} />;
        const Activity = (props) => <LucideIcon name="Activity" {...props} />;
        const XCircle = (props) => <LucideIcon name="XCircle" {...props} />;
        const Download = (props) => <LucideIcon name="Download" {...props} />;
        const Upload = (props) => <LucideIcon name="Upload" {...props} />;
        const Plus = (props) => <LucideIcon name="Plus" {...props} />;
        const Save = (props) => <LucideIcon name="Save" {...props} />;
        const Settings = (props) => <LucideIcon name="Settings" {...props} />;
        const List = (props) => <LucideIcon name="List" {...props} />;
        const Edit2 = (props) => <LucideIcon name="Edit2" {...props} />;
        const RotateCcw = (props) => <LucideIcon name="RotateCcw" {...props} />;
        const Filter = (props) => <LucideIcon name="Filter" {...props} />;
        const ArrowUpDown = (props) => <LucideIcon name="ArrowUpDown" {...props} />;
        const ArrowUp = (props) => <LucideIcon name="ArrowUp" {...props} />;
        const ArrowDown = (props) => <LucideIcon name="ArrowDown" {...props} />;
        const Code = (props) => <LucideIcon name="Code" {...props} />;


        // --- Constants & Data ---

        const ORGAN_CATEGORIES = [
            { value: 'Respiratory', label: '呼吸系統 (Respiratory)', color: 'bg-teal-100 text-teal-800' },
            { value: 'Cardiovascular', label: '心血管系統 (Cardiovascular)', color: 'bg-rose-100 text-rose-800' },
            { value: 'Renal', label: '腎臟泌尿 (Renal/Urinary)', color: 'bg-blue-100 text-blue-800' },
            { value: 'Digestive', label: '消化系統 (Digestive)', color: 'bg-orange-100 text-orange-800' },
            { value: 'Endocrine', label: '內分泌代謝 (Endocrine)', color: 'bg-yellow-100 text-yellow-800' },
            { value: 'Neurological', label: '神經系統 (Neurological)', color: 'bg-purple-100 text-purple-800' },
            { value: 'Infectious', label: '感染/敗血症 (Infectious)', color: 'bg-red-100 text-red-800' },
            { value: 'Other', label: '其他 (Other)', color: 'bg-slate-100 text-slate-800' }
        ];

        const INITIAL_DATABASE = [
            {
                "id": "urosepsis",
                "keywords": ["UROSEPSIS", "尿路敗血症"],
                "standard": "Sepsis due to urinary tract infection",
                "code": "A41.9",
                "type": "context",
                "organ": "Infectious",
                "note": "此為敗血症代碼，建議加註感染源 N39.0 (UTI)"
            },
            {
                "id": "1765282770365",
                "keywords": ["NKHS", "HHS"],
                "standard": "Type 2 diabetes mellitus with hyperosmolarity with coma (used if the patient has altered mental status/coma)",
                "code": "E11.01",
                "type": "exact",
                "organ": "Endocrine",
                "note": "E11.00: Type 2 diabetes mellitus with hyperosmolarity without coma (未昏迷)"
            },
            {
                "id": "1765280392308",
                "keywords": ["Alcoholic gastritis with bleeding", "酒精性胃炎。"],
                "standard": "Alcoholic gastritis with bleeding",
                "code": "K29.21",
                "type": "exact",
                "organ": "Other",
                "note": ""
            },
            {
                "id": "1765280347468",
                "keywords": ["Acute gastric ulcer with hemorrhage", "UGI bleeding", "GU"],
                "standard": "Acute gastric ulcer with hemorrhage",
                "code": "K25.0",
                "type": "exact",
                "organ": "Digestive",
                "note": ""
            },
            {
                "id": "1765280261361",
                "keywords": ["Esophageal varices with bleeding", "EV bleeding", "食道靜脈瘤"],
                "standard": "Esophageal varices with bleeding",
                "code": "I85.01",
                "type": "exact",
                "organ": "Digestive",
                "note": ""
            },
            {
                "id": "1765279506333",
                "keywords": ["體液缺乏"],
                "standard": "Volume depletion, unspecified",
                "code": "E86.9",
                "type": "exact",
                "organ": "Endocrine",
                "note": "E86.0: Dehydration、E86.1: Hypovolemia."
            },
            {
                "id": "1765278250857",
                "keywords": ["COVID-19", "新冠病毒"],
                "standard": "COVID-19, virus identified",
                "code": "U07.1",
                "type": "exact",
                "organ": "Respiratory",
                "note": "U07.2 COVID-19 is diagnosed clinically（臨床診斷）"
            },
            {
                "id": "1765278129792",
                "keywords": ["Mycoplasma", "黴漿菌", "急性支氣管炎"],
                "standard": "Acute bronchitis due to Mycoplasma pneumoniae",
                "code": "J20.0",
                "type": "exact",
                "organ": "Respiratory",
                "note": ""
            },
            {
                "id": "1765277774085",
                "keywords": ["Acute pharyngitis", "sorethroat", "喉嚨痛"],
                "standard": "Acute pharyngitis, unspecified",
                "code": "J02.9",
                "type": "exact",
                "organ": "Respiratory",
                "note": ""
            },
            {
                "id": "1765277626457",
                "keywords": ["來院開立其他證明書", "certification"],
                "standard": "For certification",
                "code": "Z02.79",
                "type": "exact",
                "organ": "Other",
                "note": ""
            },
            {
                "id": "1765276827042",
                "keywords": ["支氣管擴張症併(急性)發作", "bronchiectasis"],
                "standard": "Bronchiectasis with acute exacerbation",
                "code": "J47.1",
                "type": "exact",
                "organ": "Respiratory",
                "note": ""
            },
            {
                "id": "J15.0",
                "organ": "Respiratory",
                "keywords": ["J15.0", "KP PNEUMONIA", "KLEBSIELLA", "克雷白", "克雷白氏肺炎"],
                "standard": "Pneumonia due to Klebsiella pneumoniae",
                "code": "J15.0",
                "type": "exact"
            },
            {
                "id": "J15.1",
                "organ": "Respiratory",
                "keywords": ["J15.1", "PSEUDOMONAS", "綠膿桿菌"],
                "standard": "Pneumonia due to Pseudomonas",
                "code": "J15.1",
                "type": "exact"
            },
            {
                "id": "J69.0",
                "organ": "Respiratory",
                "keywords": ["J69.0", "ASPIRATION PNEUMONIA", "吸入性肺炎", "嗆入"],
                "standard": "Pneumonitis due to inhalation of food and vomit",
                "code": "J69.0",
                "type": "exact",
                "note": "常見於中風或吞嚥困難病患"
            },
            {
                "id": "J18.0",
                "organ": "Respiratory",
                "keywords": ["J18.0", "BRONCHOPNEUMONIA", "支氣管肺炎"],
                "standard": "Bronchopneumonia, unspecified organism",
                "code": "J18.0",
                "type": "exact"
            },
            {
                "id": "J18.9",
                "organ": "Respiratory",
                "keywords": ["J18.9", "PNEUMONIA", "肺炎", "PNEUMONITIS"],
                "standard": "Pneumonia, unspecified organism",
                "code": "J18.9",
                "type": "broad",
                "note": "J15.0 克雷白肺炎桿菌所致之肺炎、J15.1 綠膿桿菌所致之肺炎"
            },
            {
                "id": "J10.1",
                "organ": "Respiratory",
                "keywords": ["J10.1", "FLU CONFIRMED", "INFLUENZA A", "INFLUENZA B", "流感已確認", "流行性感冒"],
                "standard": "Influenza due to other identified influenza virus",
                "code": "J10.1",
                "type": "exact"
            },
            {
                "id": "J11.1",
                "organ": "Respiratory",
                "keywords": ["J11.1", "FLU", "SUSPECTED FLU", "疑似流感", "未確認流感"],
                "standard": "Influenza due to unidentified influenza virus",
                "code": "J11.1",
                "type": "broad"
            },
            {
                "id": "J86.9",
                "organ": "Respiratory",
                "keywords": ["J86.9", "EMPYEMA", "PYOTHORAX", "肺積膿", "膿胸"],
                "standard": "Pyothorax without fistula",
                "code": "J86.9",
                "type": "exact"
            },
            {
                "id": "J85.1",
                "organ": "Respiratory",
                "keywords": ["J85.1", "LUNG ABSCESS", "NECROTIZING PNEUMONIA", "肺膿瘍", "壞死性肺炎"],
                "standard": "Abscess of lung with pneumonia",
                "code": "J85.1",
                "type": "exact"
            },
            {
                "id": "J40",
                "organ": "Respiratory",
                "keywords": ["J40", "BRONCHITIS", "支氣管炎"],
                "standard": "Bronchitis, not specified as acute or chronic",
                "code": "J40",
                "type": "broad"
            },
            {
                "id": "J44.1",
                "organ": "Respiratory",
                "keywords": ["J44.1", "AECOPD", "COPD AE", "COPD WITH ACUTE EXACERBATION", "慢阻肺急性發作"],
                "standard": "COPD with (acute) exacerbation",
                "code": "J44.1",
                "type": "exact"
            },
            {
                "id": "J44.9",
                "organ": "Respiratory",
                "keywords": ["J44.9", "COPD", "肺阻塞", "慢性阻塞性肺病"],
                "standard": "Chronic obstructive pulmonary disease, unspecified",
                "code": "J44.9",
                "type": "exact"
            },
            {
                "id": "J91.8",
                "organ": "Respiratory",
                "keywords": ["J91.8", "PLEURAL EFFUSION", "PE", "肋膜積水", "胸水"],
                "standard": "Pleural effusion in other conditions classified elsewhere",
                "code": "J91.8",
                "type": "context",
                "note": "需搭配主診斷 (如心衰竭、肺炎)"
            },
            {
                "id": "J96.00",
                "organ": "Respiratory",
                "keywords": ["J96.00", "ACUTE RESPIRATORY FAILURE", "ARF", "急性呼吸衰竭", "respiratory failure"],
                "standard": "Acute respiratory failure, unspecified",
                "code": "J96.00",
                "type": "broad",
                "note": "J96.01 急性呼吸衰竭（缺氧性）、 J96.02 急性呼吸衰竭（高碳酸血症）"
            },
            {
                "id": "J96.01",
                "organ": "Respiratory",
                "keywords": ["J96.01", "HYPOXIC ARF", "TYPE 1 ARF", "缺氧性呼吸衰竭"],
                "standard": "Acute respiratory failure with hypoxia",
                "code": "J96.01",
                "type": "exact"
            },
            {
                "id": "J96.02",
                "organ": "Respiratory",
                "keywords": ["J96.02", "HYPERCAPNIC ARF", "TYPE 2 ARF", "高碳酸血症呼吸衰竭", "CO2 RETENTION"],
                "standard": "Acute respiratory failure with hypercapnia",
                "code": "J96.02",
                "type": "exact"
            },
            {
                "id": "J96.10",
                "organ": "Respiratory",
                "keywords": ["J96.10", "CHRONIC RESPIRATORY FAILURE", "CRF RESP", "慢性呼吸衰竭"],
                "standard": "Chronic respiratory failure, unspecified",
                "code": "J96.10",
                "type": "broad",
                "note": "J96.11 慢性呼吸衰竭（缺氧性）、 J96.12 慢性呼吸衰竭（高碳酸血症）"
            },
            {
                "id": "Z99.11",
                "organ": "Respiratory",
                "keywords": ["Z99.11", "VENTILATOR DEPENDENCE", "RCD", "呼吸器依賴", "呼吸器", "MV dependent"],
                "standard": "Dependence on respirator [ventilator] status",
                "code": "Z99.11",
                "type": "exact",
                "note": ""
            },
            {
                "id": "A15.0",
                "organ": "Respiratory",
                "keywords": ["A15.0", "TB", "TUBERCULOSIS", "肺結核", "PULMONARY TB"],
                "standard": "Tuberculosis of lung",
                "code": "A15.0",
                "type": "exact"
            },
            {
                "id": "A15.6",
                "organ": "Respiratory",
                "keywords": ["A15.6", "TB PLEURISY", "結核性肋膜炎"],
                "standard": "Tuberculous pleurisy",
                "code": "A15.6",
                "type": "exact"
            },
            {
                "id": "Z20.1",
                "organ": "Respiratory",
                "keywords": ["Z20.1", "TB CONTACT", "TB EXPOSURE", "接觸結核病"],
                "standard": "Contact with and (suspected) exposure to tuberculosis",
                "code": "Z20.1",
                "type": "exact"
            },
            {
                "id": "C34.1",
                "organ": "Respiratory",
                "keywords": ["肺癌", "肺惡性腫瘤", "lung cancer", "Adenocarcinoma", "SCLC", "NSCLC"],
                "standard": "Malignant neoplasm of Bronchus or lung, unspecified ",
                "code": "C34.9",
                "type": "exact",
                "note": "C34.0: Main bronchus、 C34.1: Upper lobe, bronchus or lung 、C34.2: Middle lobe, bronchus or lung、C34.3: Lower lobe, bronchus or lung (e.g., C34.31 for right, C34.32 for left)"
            },
            {
                "id": "R04.2",
                "organ": "Respiratory",
                "keywords": ["R04.2", "HEMOPTYSIS", "咳血"],
                "standard": "Hemoptysis",
                "code": "R04.2",
                "type": "exact"
            },
            {
                "id": "I10",
                "organ": "Cardiovascular",
                "keywords": ["I10", "HTN", "HYPERTENSION", "高血壓", "H/T"],
                "standard": "Essential (primary) hypertension",
                "code": "I10",
                "type": "exact"
            },
            {
                "id": "I11.9",
                "organ": "Cardiovascular",
                "keywords": ["I11.9", "HCVD", "高血壓性心臟病", "hypertensive cardiovascular disease"],
                "standard": "Hypertensive heart disease without heart failure",
                "code": "I11.9",
                "type": "broad",
                "note": ""
            },
            {
                "id": "I11.0",
                "organ": "Cardiovascular",
                "keywords": ["I11.0", "HCVD WITH CHF", "高血壓心臟病合併心衰竭", "hypertensive cardiovascular disease"],
                "standard": "Hypertensive heart disease with heart failure",
                "code": "I11.0",
                "type": "exact",
                "note": ""
            },
            {
                "id": "I25.9",
                "organ": "Cardiovascular",
                "keywords": ["I25.9", "IHD", "CAD", "ISCHEMIC HEART DISEASE", "冠心病", "缺血性心臟病"],
                "standard": "Chronic ischemic heart disease, unspecified",
                "code": "I25.9",
                "type": "broad"
            },
            {
                "id": "I48.0",
                "organ": "Cardiovascular",
                "keywords": ["I48.0", "PAF", "PAROXYSMAL AF", "陣發性心房顫動", "Afib", "fibrillation"],
                "standard": "Paroxysmal atrial fibrillation",
                "code": "I48.0",
                "type": "exact",
                "note": ""
            },
            {
                "id": "I48.2",
                "organ": "Cardiovascular",
                "keywords": ["I48.2", "CHRONIC AF", "PERMANENT AF", "慢性心房顫動", "Afib", "fibrillation"],
                "standard": "Chronic atrial fibrillation",
                "code": "I48.2",
                "type": "exact",
                "note": ""
            },
            {
                "id": "I48.91",
                "organ": "Cardiovascular",
                "keywords": ["I48.91", "AF", "AFIB", "ATRIAL FIBRILLATION", "心房顫動"],
                "standard": "Unspecified atrial fibrillation",
                "code": "I48.91",
                "type": "broad"
            },
            {
                "id": "I50.2",
                "organ": "Cardiovascular",
                "keywords": ["I50.2", "SYSTOLIC CHF", "HFrEF", "收縮性心衰竭", "systolic heart failure"],
                "standard": "Systolic (congestive) heart failure",
                "code": "I50.2",
                "type": "broad",
                "note": "需細分 Acute (I50.21), Chronic (I50.22) 或 Acute on Chronic (I50.23)"
            },
            {
                "id": "I50.3",
                "organ": "Cardiovascular",
                "keywords": ["I50.3", "DIASTOLIC CHF", "HFpEF", "舒張性心衰竭", "diastolic heart failure"],
                "standard": "Diastolic (congestive) heart failure",
                "code": "I50.3",
                "type": "broad",
                "note": ""
            },
            {
                "id": "I50.43",
                "organ": "Cardiovascular",
                "keywords": ["I50.43", "ACUTE ON CHRONIC CHF", "心衰竭急性發作", "acute on chronic heart failure"],
                "standard": "Acute on chronic combined systolic and diastolic heart failure",
                "code": "I50.43",
                "type": "exact",
                "note": ""
            },
            {
                "id": "I50.9",
                "organ": "Cardiovascular",
                "keywords": ["I50.9", "CHF", "HEART FAILURE", "心臟衰竭"],
                "standard": "Heart failure, unspecified",
                "code": "I50.9",
                "type": "broad"
            },
            {
                "id": "I63.9",
                "organ": "Neurological",
                "keywords": ["I63", "CVA", "STROKE", "ACUTE STROKE", "腦中風", "急性腦中風", "INFARCTION"],
                "standard": "Cerebral infarction, unspecified",
                "code": "I63.9",
                "type": "broad",
                "note": "I63 為急性梗塞，請儘量確認血管位置：I63.3: Cerebral infarction due to thrombosis of cerebral arteries (e.g., middle cerebral artery)."
            },
            {
                "id": "I69.30",
                "organ": "Neurological",
                "keywords": ["I69", "OLD CVA", "PRIOR STROKE", "陳舊性中風", "中風後遺症"],
                "standard": "Sequelae of cerebral infarction",
                "code": "I69.30",
                "type": "context"
            },
            {
                "id": "I69.959",
                "organ": "Neurological",
                "keywords": ["I69.959", "HEMIPLEGIA", "偏癱", "半身不遂"],
                "standard": "Hemiplegia following unspecified cerebrovascular disease",
                "code": "I69.959",
                "type": "exact"
            },
            {
                "id": "A41.9",
                "organ": "Infectious",
                "keywords": ["A41.9", "SEPSIS", "敗血症"],
                "standard": "Sepsis, unspecified organism",
                "code": "A41.9",
                "type": "broad",
                "note": "若有 organ dysfunction 請考慮 Severe Sepsis"
            },
            {
                "id": "R65.20",
                "organ": "Infectious",
                "keywords": ["R65.20", "SEVERE SEPSIS", "嚴重敗血症"],
                "standard": "Severe sepsis without septic shock",
                "code": "R65.20",
                "type": "exact"
            },
            {
                "id": "R65.21",
                "organ": "Infectious",
                "keywords": ["R65.21", "SEPTIC SHOCK", "敗血性休克"],
                "standard": "Severe sepsis with septic shock",
                "code": "R65.21",
                "type": "exact"
            },
            {
                "id": "N39.0",
                "organ": "Renal",
                "keywords": ["N39.0", "UTI", "URINARY TRACT INFECTION", "泌尿道感染"],
                "standard": "Urinary tract infection, site not specified",
                "code": "N39.0",
                "type": "exact"
            },
            {
                "id": "E11.9",
                "organ": "Endocrine",
                "keywords": ["E11.9", "DM", "DIABETES", "糖尿病", "TYPE 2 DM"],
                "standard": "Type 2 diabetes mellitus without complications",
                "code": "E11.9",
                "type": "broad"
            },
            {
                "id": "E11.65",
                "organ": "Endocrine",
                "keywords": ["E11.65", "DM HIGH SUGAR", "HYPERGLYCEMIA", "高血糖"],
                "standard": "Type 2 diabetes mellitus with hyperglycemia",
                "code": "E11.65",
                "type": "exact"
            },
            {
                "id": "E78.2",
                "organ": "Endocrine",
                "keywords": ["E78.2", "HYPERLIPIDEMIA", "MIXED HYPERLIPIDEMIA", "高血脂", "混合型高血脂"],
                "standard": "Mixed hyperlipidemia",
                "code": "E78.2",
                "type": "exact"
            },
            {
                "id": "E86.0",
                "organ": "Endocrine",
                "keywords": ["E86.0", "DEHYDRATION", "脫水", "prerenal azotemia"],
                "standard": "Dehydration",
                "code": "E86.0",
                "type": "exact",
                "note": ""
            },
            {
                "id": "E86.1",
                "organ": "Endocrine",
                "keywords": ["E86.1", "HYPOVOLEMIA", "低血容量"],
                "standard": "Hypovolemia （decreased blood volume with electrolyte loss）",
                "code": "E86.1",
                "type": "exact",
                "note": ""
            },
            {
                "id": "E87.1",
                "organ": "Endocrine",
                "keywords": ["E87.1", "HYPONATREMIA", "LOW SODIUM", "低血鈉"],
                "standard": "Hypo-osmolality and hyponatremia",
                "code": "E87.1",
                "type": "exact"
            },
            {
                "id": "E87.5",
                "organ": "Endocrine",
                "keywords": ["E87.5", "HYPERKALEMIA", "HIGH K", "高血鉀"],
                "standard": "Hyperkalemia",
                "code": "E87.5",
                "type": "exact"
            },
            {
                "id": "E87.6",
                "organ": "Endocrine",
                "keywords": ["E87.6", "HYPOKALEMIA", "LOW K", "低血鉀"],
                "standard": "Hypokalemia",
                "code": "E87.6",
                "type": "exact"
            },
            {
                "id": "N17.9",
                "organ": "Renal",
                "keywords": ["N17.9", "AKI", "ACUTE RENAL FAILURE", "急性腎衰竭"],
                "standard": "Acute kidney failure, unspecified",
                "code": "N17.9",
                "type": "exact"
            },
            {
                "id": "Z99.2",
                "organ": "Renal",
                "keywords": ["Z99.2", "ESRD", "DIALYSIS", "洗腎", "血液透析"],
                "standard": "Dependence on renal dialysis",
                "code": "Z99.2",
                "type": "exact"
            },
            {
                "id": "N40.0",
                "organ": "Renal",
                "keywords": ["N40.0", "BPH", "攝護腺肥大"],
                "standard": "Benign prostatic hyperplasia without lower urinary tract symptoms",
                "code": "N40.0",
                "type": "exact"
            },
            {
                "id": "N40.1",
                "organ": "Renal",
                "keywords": ["N40.1", "SYMPTOMATIC BPH", "攝護腺肥大合併症狀", "BPH"],
                "standard": "Benign prostatic hyperplasia with lower urinary tract symptoms",
                "code": "N40.1",
                "type": "exact",
                "note": ""
            },
            {
                "id": "K21.0",
                "organ": "Digestive",
                "keywords": ["K21.0", "GERD", "REFLUX ESOPHAGITIS", "逆流性食道炎", "胃食道逆流合併食道炎"],
                "standard": "Gastro-esophageal reflux disease with esophagitis",
                "code": "K21.0",
                "type": "exact"
            },
            {
                "id": "K27.9",
                "organ": "Digestive",
                "keywords": ["K27.9", "PUD", "PEPTIC ULCER", "消化性潰瘍", "潰瘍"],
                "standard": "Peptic ulcer, site unspecified",
                "code": "K27.9",
                "type": "broad"
            },
            {
                "id": "K92.2",
                "organ": "Digestive",
                "keywords": ["K92.2", "GIB", "UGI BLEEDING", "胃腸道出血", "腸胃出血"],
                "standard": "Gastrointestinal hemorrhage, unspecified",
                "code": "K92.2",
                "type": "broad",
                "note": "K92.0: Hematemesis (Vomiting blood) 、K92.1: Melena (Black, tarry stools, indicating upper GI bleeding)"
            },
            {
                "id": "K56.0",
                "organ": "Digestive",
                "keywords": ["K56.0", "ILEUS", "PARALYTIC ILEUS", "麻痺性腸阻塞"],
                "standard": "Paralytic ileus",
                "code": "K56.0",
                "type": "exact"
            },
            {
                "id": "K56.7",
                "organ": "Digestive",
                "keywords": ["K56.7", "BOWEL OBSTRUCTION", "腸阻塞"],
                "standard": "Ileus, unspecified",
                "code": "K56.7",
                "type": "broad"
            },
            {
                "id": "K59.00",
                "organ": "Digestive",
                "keywords": ["K59.00", "CONSTIPATION", "便秘"],
                "standard": "Constipation, unspecified",
                "code": "K59.00",
                "type": "exact"
            },
            {
                "id": "R57.1",
                "organ": "Other",
                "keywords": ["R57.1", "HYPOVOLEMIC SHOCK", "低血容性休克"],
                "standard": "Hypovolemic shock",
                "code": "R57.1",
                "type": "exact"
            },
            {
                "id": "R57.8",
                "organ": "Other",
                "keywords": ["R57.8", "SHOCK", "其他休克"],
                "standard": "Other shock",
                "code": "R57.8",
                "type": "broad"
            },
            {
                "id": "D64.9",
                "organ": "Other",
                "keywords": ["D64.9", "ANEMIA", "貧血"],
                "standard": "Anemia, unspecified",
                "code": "D64.9",
                "type": "broad"
            },
            {
                "id": "R93.8",
                "organ": "Other",
                "keywords": ["R93.8", "ABNORMAL IMAGING", "影像異常"],
                "standard": "Abnormal findings on diagnostic imaging of other specified body structures",
                "code": "R93.8",
                "type": "exact"
            },
            {
                "id": "L89",
                "organ": "Other",
                "keywords": ["L89", "PRESSURE SORE", "BED SORE", "褥瘡", "壓瘡"],
                "standard": "Pressure ulcer",
                "code": "L89.90",
                "type": "broad",
                "note": "請指定部位與分級 (Stage 1-4)"
            },
            {
                "id": "R42",
                "organ": "Neurological",
                "keywords": ["R42", "DIZZINESS", "VERTIGO", "頭暈", "眩暈"],
                "standard": "Dizziness and giddiness",
                "code": "R42",
                "type": "exact"
            }
        ];

        const IGNORE_LIST = [
            'ASPIRIN', 'PLAVIX', 'METFORMIN', 'LASIX', 'KCL', 'N/S', 'BOKEY', 'NORVASC', 
            'LIPITOR', 'INSULIN', 'ANTIBIOTICS', 'IV', 'PO', 'BID', 'QID', 'TID', 'PRN', 
            'ADMISSION', 'DISCHARGE', 'MBD', 'OBSERVATION', 'VITALS', 'BP', 'HR', 'RR', 'BT',
            'CURRENT MEDICATIONS', 'ALLERGIES', 'PLAN', 'SOAP'
        ];

        // --- Main Component ---
        const App = () => {
            const fileInputRef = useRef(null);

            // Lazy Initialization from LocalStorage
            const [database, setDatabase] = useState(() => {
                try {
                    const savedDb = localStorage.getItem('icd10_custom_db');
                    if (savedDb) {
                        const parsed = JSON.parse(savedDb);
                        return parsed.map(item => ({
                            ...item,
                            organ: item.organ || 'Other' 
                        }));
                    }
                    return INITIAL_DATABASE;
                } catch (e) {
                    console.error("Failed to load initial DB", e);
                    return INITIAL_DATABASE;
                }
            });

            const [inputText, setInputText] = useState('');
            const [results, setResults] = useState([]);
            
            // UI States
            const [activeTab, setActiveTab] = useState('coding'); 
            const [isProcessing, setIsProcessing] = useState(false);
            const [progressStep, setProgressStep] = useState(0); 
            const [sortConfig, setSortConfig] = useState({ key: 'code', direction: 'asc' });
            const [editingId, setEditingId] = useState(null);

            // New/Edit Rule Form
            const [newRule, setNewRule] = useState({
                code: '',
                standard: '',
                keywords: '',
                type: 'exact',
                organ: 'Other', 
                note: ''
            });

            // Auto-save to LocalStorage
            useEffect(() => {
                localStorage.setItem('icd10_custom_db', JSON.stringify(database));
            }, [database]);

            const handleSmartResetDb = () => {
                if (window.confirm('確定要還原系統預設值嗎？\n\n不用擔心！您的「自訂規則」會被保留下來，只有內建的規則會被重置到最新版本。')) {
                    const initialIds = new Set(INITIAL_DATABASE.map(item => item.id));
                    const customRules = database.filter(item => !initialIds.has(item.id));
                    const mergedDb = [...customRules, ...INITIAL_DATABASE];
                    
                    setDatabase(mergedDb);
                    alert(`重置完成！\n保留了 ${customRules.length} 筆自訂規則。\n還原了 ${INITIAL_DATABASE.length} 筆系統規則。`);
                }
            };

            const handleExportDb = () => {
                const dataStr = JSON.stringify(database, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `icd10_backup_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('資料庫備份檔 (.json) 已下載！\n若要永久更新程式碼，請使用右側的「複製完整資料庫」功能。');
            };

            const handleCopyForDeveloper = () => {
                const cleanDb = database.map(({ isCustom, ...rest }) => rest);
                const jsonString = JSON.stringify(cleanDb, null, 2);
                
                navigator.clipboard.writeText(jsonString).then(() => {
                    alert(
                        '已複製完整資料庫內容！\n\n' +
                        '【永久保存步驟】\n' +
                        '1. 請將複製的內容貼給 AI，並說：「請用這些資料更新 App.jsx 的預設資料庫」。\n' +
                        '2. 或者，若您是開發者，請直接覆蓋程式碼中的 INITIAL_DATABASE 常數。'
                    );
                });
            };

            const handleImportClick = () => {
                fileInputRef.current.click();
            };

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (Array.isArray(importedData)) {
                            if (window.confirm(`確定要匯入 ${importedData.length} 筆規則嗎？\n這將會覆蓋您目前的資料庫。`)) {
                                setDatabase(importedData);
                                alert('資料庫匯入成功！');
                            }
                        } else {
                            alert('匯入失敗：檔案格式不正確。');
                        }
                    } catch (error) {
                        alert('匯入失敗：無法讀取檔案。');
                        console.error(error);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const requestSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setSortConfig({ key, direction });
            };

            const sortedDatabase = useMemo(() => {
                let sortableItems = [...database];
                if (sortConfig.key) {
                    sortableItems.sort((a, b) => {
                        let valA = a[sortConfig.key] || '';
                        let valB = b[sortConfig.key] || '';
                        
                        if (sortConfig.key === 'organ') {
                           if (valA === 'Other') return 1;
                           if (valB === 'Other') return -1;
                        }

                        if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                return sortableItems;
            }, [database, sortConfig]);

            const handleAnalyze = () => {
                if (!inputText.trim()) return;
                
                setIsProcessing(true);
                setResults([]);
                setProgressStep(1);

                setTimeout(() => {
                    setProgressStep(2);
                    setTimeout(() => {
                        setProgressStep(3);
                        setTimeout(() => {
                            performCoding();
                            setIsProcessing(false);
                            setProgressStep(0);
                        }, 500);
                    }, 500);
                }, 500);
            };

            const performCoding = () => {
                const segments = inputText.split(/[\n,;，、。/:().?]+/).map(s => s.trim()).filter(s => s.length > 0);
                const newResults = [];
                const usedCodes = new Set();

                const processSegment = (rawSegment) => {
                    const cleanSegment = rawSegment.toUpperCase();
                    if (cleanSegment.length < 2) return;
                    
                    const isIgnored = IGNORE_LIST.some(ignore => {
                        if (ignore.length <= 4) {
                            const escapedIgnore = ignore.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                            const regex = new RegExp(`\\b${escapedIgnore}\\b`);
                            return regex.test(cleanSegment);
                        }
                        return cleanSegment.includes(ignore);
                    });

                    if (isIgnored) return;

                    let match = null;
                    let highestRelevance = 0;

                    database.forEach(entry => {
                        entry.keywords.forEach(keyword => {
                            const k = keyword.toUpperCase();
                            if (cleanSegment === k) {
                                if (k.length > highestRelevance) {
                                    highestRelevance = k.length + 100;
                                    match = { ...entry, original: rawSegment };
                                }
                            }
                            else if (cleanSegment.includes(k)) {
                                const currentScore = k.length;
                                if (currentScore > highestRelevance) {
                                    highestRelevance = currentScore;
                                    match = { ...entry, original: rawSegment };
                                }
                            }
                        });
                    });

                    if (match) {
                        if (!usedCodes.has(match.code)) {
                            newResults.push(match);
                            usedCodes.add(match.code);
                        }
                    }
                };

                segments.forEach(seg => {
                   processSegment(seg);
                });

                setResults(newResults);
            };

            const handleSaveRule = () => {
                if (!newRule.code || !newRule.standard || !newRule.keywords) {
                    alert('請填寫完整資訊 (代碼、標準名稱、關鍵字)');
                    return;
                }

                const keywordsArray = newRule.keywords.split(/[,，、]/).map(k => k.trim()).filter(k => k.length > 0);

                const ruleData = {
                    keywords: keywordsArray,
                    standard: newRule.standard,
                    code: newRule.code,
                    type: newRule.type,
                    organ: newRule.organ,
                    note: newRule.note,
                    isCustom: true 
                };

                if (editingId) {
                    setDatabase(prev => prev.map(item => {
                        if (item.id === editingId) {
                            return { ...item, ...ruleData };
                        }
                        return item;
                    }));
                    alert('更新成功！已保存至瀏覽器。');
                    handleCancelEdit();
                } else {
                    const newItem = {
                        id: Date.now().toString(),
                        ...ruleData
                    };
                    setDatabase(prev => [newItem, ...prev]); 
                    alert('新增成功！已保存至瀏覽器。');
                    setNewRule({ code: '', standard: '', keywords: '', type: 'exact', organ: 'Other', note: '' });
                }
            };

            const handleEditRule = (rule) => {
                setEditingId(rule.id);
                setNewRule({
                    code: rule.code,
                    standard: rule.standard,
                    keywords: rule.keywords.join(', '),
                    type: rule.type,
                    organ: rule.organ || 'Other',
                    note: rule.note || ''
                });
            };

            const handleCancelEdit = () => {
                setEditingId(null);
                setNewRule({ code: '', standard: '', keywords: '', type: 'exact', organ: 'Other', note: '' });
            };

            const handleDeleteRule = (id) => {
                if (window.confirm('確定要刪除這條規則嗎？')) {
                    setDatabase(prev => prev.filter(item => item.id !== id));
                    if (editingId === id) {
                        handleCancelEdit();
                    }
                }
            };

            const clearAll = () => {
                setInputText('');
                setResults([]);
                setProgressStep(0);
            };

            const copyToClipboard = () => {
                const text = results.map(r => `${r.code} - ${r.standard}`).join('\n');
                navigator.clipboard.writeText(text);
                alert('編碼結果已複製到剪貼簿');
            };

            const getOrganColor = (organValue) => {
                const category = ORGAN_CATEGORIES.find(c => c.value === organValue);
                return category ? category.color : 'bg-slate-100 text-slate-800';
            };
            
            const getOrganLabel = (organValue) => {
                const category = ORGAN_CATEGORIES.find(c => c.value === organValue);
                return category ? category.label.split(' ')[0] : organValue; 
            };

            const SortIcon = ({ colKey }) => {
                if (sortConfig.key !== colKey) return <ArrowUpDown className="w-3 h-3 ml-1 text-slate-300" />;
                return sortConfig.direction === 'asc' 
                    ? <ArrowUp className="w-3 h-3 ml-1 text-blue-600" /> 
                    : <ArrowDown className="w-3 h-3 ml-1 text-blue-600" />;
            };

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800">
                    <input 
                        type="file" 
                        ref={fileInputRef} 
                        onChange={handleFileChange} 
                        style={{ display: 'none' }} 
                        accept=".json"
                    />

                    {/* Header */}
                    <header className="bg-blue-900 text-white shadow-lg sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                            <div className="flex items-center space-x-3">
                                <Stethoscope className="w-8 h-8 text-blue-300" />
                                <div>
                                    <h1 className="text-xl font-bold tracking-wide">內科醫學編碼互動式平台</h1>
                                    <p className="text-xs text-blue-200">ICD-10-CM Internal Medicine Coding Assistant</p>
                                </div>
                            </div>
                            
                            <div className="flex bg-blue-800 rounded-lg p-1 space-x-1">
                                <button 
                                    onClick={() => setActiveTab('coding')}
                                    className={`px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center ${
                                        activeTab === 'coding' ? 'bg-white text-blue-900 shadow-sm' : 'text-blue-200 hover:bg-blue-700'
                                    }`}
                                >
                                    <Search className="w-4 h-4 mr-2" />
                                    臨床編碼
                                </button>
                                <button 
                                    onClick={() => setActiveTab('database')}
                                    className={`px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center ${
                                        activeTab === 'database' ? 'bg-white text-blue-900 shadow-sm' : 'text-blue-200 hover:bg-blue-700'
                                    }`}
                                >
                                    <Database className="w-4 h-4 mr-2" />
                                    資料庫管理
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-4 py-6 h-[calc(100vh-90px)]">
                        
                        {/* VIEW 1: CODING WORKSPACE */}
                        {activeTab === 'coding' && (
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                                {/* Left Panel: Input */}
                                <div className="flex flex-col space-y-4 h-full">
                                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 flex flex-col p-4">
                                        <div className="flex justify-between items-center mb-2">
                                            <label className="text-sm font-bold text-slate-700 flex items-center">
                                                <FileText className="w-4 h-4 mr-2 text-blue-600" />
                                                臨床文字內容 (Clinical Notes)
                                            </label>
                                            <div className="text-xs text-slate-400">支援中文、英文及常用縮寫</div>
                                        </div>
                                        
                                        <textarea
                                            className="flex-1 w-full p-4 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none resize-none font-mono text-sm leading-relaxed"
                                            placeholder="請在此貼上臨床筆記...
例如：
Pt with h/o DM and HTN.
Impression:
1. Urosepsis/Septic shock
2. Klebsiella Pneumonia"
                                            value={inputText}
                                            onChange={(e) => setInputText(e.target.value)}
                                        />
                                        
                                        <div className="mt-4 flex space-x-3">
                                            <button 
                                                onClick={handleAnalyze}
                                                disabled={isProcessing || !inputText}
                                                className={`flex-1 py-3 rounded-lg font-bold shadow-sm flex items-center justify-center transition-all ${
                                                    isProcessing || !inputText 
                                                        ? 'bg-slate-200 text-slate-400 cursor-not-allowed' 
                                                        : 'bg-blue-600 hover:bg-blue-700 text-white shadow-blue-200'
                                                }`}
                                            >
                                                {isProcessing ? (
                                                    <span className="flex items-center">
                                                        <span className="animate-spin mr-2">●</span> 分析中...
                                                    </span>
                                                ) : (
                                                    <span className="flex items-center">
                                                        <Search className="w-5 h-5 mr-2" /> 開始分析與編碼
                                                    </span>
                                                )}
                                            </button>
                                            <button onClick={clearAll} className="px-4 py-3 bg-white border border-slate-300 text-slate-600 rounded-lg hover:bg-slate-50">
                                                <Trash2 className="w-5 h-5" />
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* Right Panel: Output */}
                                <div className="flex flex-col h-full overflow-hidden">
                                    {isProcessing && (
                                        <div className="mb-4 bg-white p-4 rounded-xl shadow-sm border border-slate-200 animate-pulse">
                                            <div className="flex justify-between text-xs font-bold text-slate-500 mb-2">
                                                <span className={progressStep >= 1 ? 'text-blue-600' : ''}>1. Extraction</span>
                                                <span className={progressStep >= 2 ? 'text-blue-600' : ''}>2. Normalization</span>
                                                <span className={progressStep >= 3 ? 'text-blue-600' : ''}>3. Coding</span>
                                            </div>
                                            <div className="w-full bg-slate-100 rounded-full h-2">
                                                <div className="bg-blue-500 h-2 rounded-full transition-all duration-300" style={{ width: `${progressStep * 33.3}%` }}></div>
                                            </div>
                                        </div>
                                    )}

                                    <div className="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                                        <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                            <h2 className="font-bold text-slate-700 flex items-center">
                                                <List className="w-4 h-4 mr-2 text-green-600" />
                                                編碼結果
                                            </h2>
                                            {results.length > 0 && (
                                                <button onClick={copyToClipboard} className="flex items-center text-xs bg-white border border-slate-300 px-3 py-1.5 rounded hover:bg-slate-50 text-slate-600">
                                                    <Copy className="w-3 h-3 mr-1" /> 複製
                                                </button>
                                            )}
                                        </div>

                                        <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/50">
                                            {results.length === 0 && !isProcessing && (
                                                <div className="h-full flex flex-col items-center justify-center text-slate-400">
                                                    <Activity className="w-16 h-16 mb-4 opacity-20" />
                                                    <p>請輸入臨床筆記</p>
                                                </div>
                                            )}

                                            {results.map((item, index) => (
                                                <div key={index} className={`relative p-4 rounded-lg border-l-4 shadow-sm bg-white ${
                                                    item.type === 'unknown' ? 'border-l-red-400 border border-red-100' :
                                                    item.type === 'broad' ? 'border-l-amber-400 border border-amber-100' : 
                                                    'border-l-green-500 border border-slate-100'
                                                }`}>
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex flex-col">
                                                           <span className="text-xs font-mono bg-slate-100 text-slate-500 px-2 py-0.5 rounded w-fit mb-1">原始: {item.original}</span>
                                                           {item.organ && item.organ !== 'Other' && (
                                                             <span className={`text-[10px] w-fit px-2 py-0.5 rounded-full ${getOrganColor(item.organ)}`}>
                                                               {getOrganLabel(item.organ)}
                                                             </span>
                                                           )}
                                                        </div>
                                                        <span className={`text-xl font-bold font-mono ${item.type === 'unknown' ? 'text-red-600' : 'text-blue-700'}`}>{item.code}</span>
                                                    </div>
                                                    <h3 className="text-lg font-semibold text-slate-800 mb-1">{item.standard}</h3>
                                                    {item.note && (
                                                        <div className="mt-2 text-xs flex items-start bg-amber-50 text-amber-800 p-2 rounded">
                                                            <AlertTriangle className="w-3 h-3 mr-1.5 mt-0.5 flex-shrink-0" />
                                                            {item.note}
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* VIEW 2: DATABASE MANAGER */}
                        {activeTab === 'database' && (
                            <div className="h-full flex flex-col lg:flex-row gap-6">
                                {/* Add/Edit Rule Panel */}
                                <div className="lg:w-1/3 flex flex-col space-y-4">
                                    <div className={`rounded-xl shadow-sm border p-5 overflow-y-auto transition-colors ${
                                        editingId ? 'bg-amber-50 border-amber-200' : 'bg-white border-slate-200'
                                    }`}>
                                        <h2 className={`text-lg font-bold mb-4 flex items-center ${
                                            editingId ? 'text-amber-800' : 'text-slate-800'
                                        }`}>
                                            {editingId ? (
                                                <React.Fragment>
                                                    <Edit2 className="w-5 h-5 mr-2" /> 編輯規則
                                                </React.Fragment>
                                            ) : (
                                                <React.Fragment>
                                                    <Plus className="w-5 h-5 mr-2 text-blue-600" /> 新增編碼規則
                                                </React.Fragment>
                                            )}
                                        </h2>
                                        
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1">ICD-10 Code</label>
                                                    <input 
                                                        type="text" 
                                                        className="w-full p-2 border border-slate-300 rounded font-mono focus:ring-2 focus:ring-blue-500 outline-none"
                                                        placeholder="e.g. E11.9"
                                                        value={newRule.code}
                                                        onChange={(e) => setNewRule({...newRule, code: e.target.value})}
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1">器官/系統 (Organ)</label>
                                                    <select 
                                                        className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white"
                                                        value={newRule.organ}
                                                        onChange={(e) => setNewRule({...newRule, organ: e.target.value})}
                                                    >
                                                        {ORGAN_CATEGORIES.map(cat => (
                                                            <option key={cat.value} value={cat.value}>{cat.label}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 mb-1">標準診斷名稱 (Standard Term)</label>
                                                <input 
                                                    type="text" 
                                                    className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                                                    placeholder="e.g. Type 2 diabetes mellitus"
                                                    value={newRule.standard}
                                                    onChange={(e) => setNewRule({...newRule, standard: e.target.value})}
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 mb-1">識別關鍵字 (用逗號分隔)</label>
                                                <textarea 
                                                    className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none h-20 text-sm"
                                                    placeholder="例如: DM, 糖尿病, Sugar high"
                                                    value={newRule.keywords}
                                                    onChange={(e) => setNewRule({...newRule, keywords: e.target.value})}
                                                />
                                                <p className="text-[10px] text-slate-400 mt-1">
                                                    {editingId ? '您可以在此處增修更多關鍵字。' : '系統會自動識別這些關鍵字並轉換為上方代碼。'}
                                                </p>
                                            </div>

                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 mb-1">匹配類型 (Type)</label>
                                                <select 
                                                    className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white"
                                                    value={newRule.type}
                                                    onChange={(e) => setNewRule({...newRule, type: e.target.value})}
                                                >
                                                    <option value="exact">Exact (精確)</option>
                                                    <option value="broad">Broad (廣泛/需細分)</option>
                                                    <option value="context">Context (背景資訊)</option>
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 mb-1">備註/警示 (選填)</label>
                                                <input 
                                                    type="text" 
                                                    className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                                                    placeholder="提示使用者注意併發症..."
                                                    value={newRule.note}
                                                    onChange={(e) => setNewRule({...newRule, note: e.target.value})}
                                                />
                                            </div>

                                            <div className="flex space-x-2">
                                                {editingId && (
                                                    <button 
                                                        onClick={handleCancelEdit}
                                                        className="flex-1 py-2 bg-white border border-slate-300 text-slate-600 rounded-lg font-bold hover:bg-slate-50 transition-colors flex items-center justify-center"
                                                    >
                                                        <XCircle className="w-4 h-4 mr-2" />
                                                        取消
                                                    </button>
                                                )}
                                                <button 
                                                    onClick={handleSaveRule}
                                                    className={`flex-1 py-2 text-white rounded-lg font-bold shadow-md transition-colors flex items-center justify-center ${
                                                        editingId ? 'bg-amber-600 hover:bg-amber-700' : 'bg-blue-600 hover:bg-blue-700'
                                                    }`}
                                                >
                                                    <Save className="w-4 h-4 mr-2" />
                                                    {editingId ? '更新規則' : '儲存到規則庫'}
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-blue-50 rounded-xl p-4 text-xs text-blue-800 border border-blue-100">
                                        <p>💡 提示：您可以利用新增的「排序」按鈕來依照器官系統或代碼整理規則，方便快速查找。</p>
                                    </div>
                                </div>

                                {/* Existing Rules List */}
                                <div className="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                                    {/* Header with Sort Controls */}
                                    <div className="p-4 border-b border-slate-100 flex flex-col gap-3 bg-slate-50">
                                        <div className="flex justify-between items-center">
                                            <h2 className="font-bold text-slate-700">目前規則庫 ({sortedDatabase.length})</h2>
                                            
                                            {/* Action Buttons */}
                                            <div className="flex items-center space-x-2">
                                                <button onClick={handleExportDb} className="text-xs flex items-center text-blue-600 hover:bg-blue-50 px-2 py-1 rounded border border-blue-200 transition-colors" title="備份資料庫 (.json)">
                                                    <Download className="w-3 h-3 mr-1" /> 備份
                                                </button>
                                                <button onClick={handleImportClick} className="text-xs flex items-center text-emerald-600 hover:bg-emerald-50 px-2 py-1 rounded border border-emerald-200 transition-colors" title="還原資料庫 (.json)">
                                                    <Upload className="w-3 h-3 mr-1" /> 匯入
                                                </button>
                                                <button onClick={handleCopyForDeveloper} className="text-xs flex items-center text-purple-600 hover:bg-purple-50 px-2 py-1 rounded border border-purple-200 transition-colors" title="複製完整資料庫 (給開發者)">
                                                    <Code className="w-3 h-3 mr-1" /> 給開發者
                                                </button>
                                                <div className="h-4 w-px bg-slate-300 mx-1"></div>
                                                <button onClick={handleSmartResetDb} className="text-xs text-red-500 hover:text-red-700 underline flex items-center" title="重置為系統預設值 (保留自訂規則)">
                                                    <RotateCcw className="w-3 h-3 mr-1" /> 重置預設值
                                                </button>
                                            </div>
                                        </div>
                                        
                                        {/* Sort Control Bar */}
                                        <div className="flex items-center gap-2 text-xs">
                                            <span className="text-slate-500 font-bold">排序方式 (Sort by):</span>
                                            <div className="flex bg-white rounded border border-slate-200 p-0.5">
                                                <button 
                                                    onClick={() => requestSort('code')}
                                                    className={`px-3 py-1 rounded flex items-center transition-colors ${
                                                        sortConfig.key === 'code' ? 'bg-blue-100 text-blue-700 font-bold' : 'text-slate-600 hover:bg-slate-50'
                                                    }`}
                                                >
                                                    Code <SortIcon colKey="code" />
                                                </button>
                                                <button 
                                                    onClick={() => requestSort('organ')}
                                                    className={`px-3 py-1 rounded flex items-center transition-colors ${
                                                        sortConfig.key === 'organ' ? 'bg-blue-100 text-blue-700 font-bold' : 'text-slate-600 hover:bg-slate-50'
                                                    }`}
                                                >
                                                    Organ <SortIcon colKey="organ" />
                                                </button>
                                                <button 
                                                    onClick={() => requestSort('standard')}
                                                    className={`px-3 py-1 rounded flex items-center transition-colors ${
                                                        sortConfig.key === 'standard' ? 'bg-blue-100 text-blue-700 font-bold' : 'text-slate-600 hover:bg-slate-50'
                                                    }`}
                                                >
                                                    Term <SortIcon colKey="standard" />
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex-1 overflow-y-auto p-0">
                                        <table className="w-full text-sm text-left">
                                            <thead className="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0 shadow-sm z-10">
                                                <tr>
                                                    <th className="px-4 py-3 cursor-pointer hover:bg-slate-100 transition-colors" onClick={() => requestSort('code')}>
                                                        <div className="flex items-center">Code / Organ <SortIcon colKey="code" /></div>
                                                    </th>
                                                    <th className="px-4 py-3 cursor-pointer hover:bg-slate-100 transition-colors" onClick={() => requestSort('standard')}>
                                                        <div className="flex items-center">Term & Keywords <SortIcon colKey="standard" /></div>
                                                    </th>
                                                    <th className="px-4 py-3 text-right">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {sortedDatabase.map((item) => (
                                                    <tr key={item.id} className={`hover:bg-slate-50 ${editingId === item.id ? 'bg-amber-50' : ''}`}>
                                                        <td className="px-4 py-3 font-mono align-top w-32">
                                                            <div className="font-bold text-blue-700">{item.code}</div>
                                                            <div className={`mt-1 text-[10px] w-fit px-1.5 py-0.5 rounded ${getOrganColor(item.organ)}`}>
                                                                {getOrganLabel(item.organ || 'Other')}
                                                            </div>
                                                            {item.type === 'broad' && <div className="mt-1 text-[10px] bg-amber-100 text-amber-800 px-1 rounded w-fit">Broad</div>}
                                                            {item.type === 'context' && <div className="mt-1 text-[10px] bg-purple-100 text-purple-800 px-1 rounded w-fit">Context</div>}
                                                        </td>
                                                        <td className="px-4 py-3 align-top">
                                                            <div className="font-medium text-slate-800">{item.standard}</div>
                                                            <div className="mt-1 flex flex-wrap gap-1">
                                                                {item.keywords.map((k, i) => (
                                                                    <span key={i} className="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded border border-slate-200">
                                                                        {k}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                            {item.note && <div className="text-[10px] text-amber-600 mt-1 italic">{item.note}</div>}
                                                        </td>
                                                        <td className="px-4 py-3 text-right align-top whitespace-nowrap">
                                                            <button 
                                                                onClick={() => handleEditRule(item)}
                                                                className={`p-1 rounded transition-colors mr-2 ${
                                                                    editingId === item.id 
                                                                        ? 'text-amber-600 bg-amber-100' 
                                                                        : 'text-slate-400 hover:text-blue-600 hover:bg-blue-50'
                                                                }`}
                                                                title="編輯"
                                                            >
                                                                <Edit2 className="w-4 h-4" />
                                                            </button>
                                                            <button 
                                                                onClick={() => handleDeleteRule(item.id)}
                                                                className="text-slate-400 hover:text-red-500 p-1 rounded hover:bg-red-50 transition-colors"
                                                                title="刪除"
                                                            >
                                                                <Trash2 className="w-4 h-4" />
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>