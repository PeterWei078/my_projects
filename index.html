<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>肺癌分期評估工具 (IASLC 第9版)</title>
    
    <!-- 1. 錯誤處理：如果 React 無法載入，顯示錯誤訊息 -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const root = document.getElementById('root');
            // 只有在畫面還停留在"載入中"才顯示錯誤，避免干擾正常執行
            if (root && (root.innerText.includes('載入中') || root.innerHTML === '')) {
                root.innerHTML = `
                    <div style="color: #b91c1c; background: #fef2f2; padding: 24px; border-radius: 12px; border: 1px solid #fca5a5; max-width: 600px; margin: 40px auto; font-family: sans-serif;">
                        <h2 style="margin-top:0; font-size: 1.5rem; font-weight: bold;">⚠️ 程式無法執行</h2>
                        <p style="margin: 16px 0;">瀏覽器將此檔案視為純文字或無法載入元件。</p>
                        <p><strong>Mac 使用者請注意：</strong></p>
                        <ul style="padding-left: 20px; line-height: 1.6;">
                            <li>請確認檔名結尾是 <strong>.html</strong> 而不是 <em>.html.txt</em>。</li>
                            <li>使用「文字編輯」存檔時，請務必先按 <strong>Shift+Cmd+T</strong> 轉為純文字格式。</li>
                        </ul>
                        <div style="margin-top: 16px; padding: 12px; background: #fff; border: 1px solid #e5e7eb; border-radius: 6px; font-family: monospace; font-size: 0.9em; color: #374151;">
                            系統回報錯誤: ${message}
                        </div>
                    </div>
                `;
            }
        };
    </script>

    <!-- 2. 引入樣式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 3. 引入 React 核心 -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 4. 引入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", "Noto Sans TC", sans-serif; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 300ms; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="root" class="flex flex-col items-center justify-center min-h-screen text-gray-500">
        <!-- 載入動畫 -->
        <svg class="animate-spin h-10 w-10 mb-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-lg font-medium">系統載入中...</p>
        <p class="text-sm mt-2 opacity-75">正在初始化 React 元件</p>
    </div>

    <!-- 5. 主程式邏輯 -->
    <script type="text/babel" data-presets="env,react">
        const { useState, useEffect } = React;

        // --- Icons Components ---
        const IconBase = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const InfoIcon = (props) => (
            <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>
        );
        const RotateCcwIcon = (props) => (
            <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>
        );
        const ActivityIcon = (props) => (
            <IconBase {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconBase>
        );
        const StethoscopeIcon = (props) => (
            <IconBase {...props}><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></IconBase>
        );
        const AlertCircleIcon = (props) => (
            <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>
        );
        const CheckCircle2Icon = (props) => (
            <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></IconBase>
        );

        // --- Data Definitions (IASLC 9th Edition) ---
        const tOptions = [
            { 
                value: 'Tx', 
                label: 'Tx', 
                desc: '原發腫瘤無法評估', 
                details: ['痰液或支氣管沖洗液中發現惡性細胞，但影像學或支氣管鏡未發現腫瘤'] 
            },
            { 
                value: 'T0', 
                label: 'T0', 
                desc: '無原發腫瘤證據', 
                details: [] 
            },
            { 
                value: 'Tis', 
                label: 'Tis', 
                desc: '原位癌 (Carcinoma in situ)', 
                details: ['AIS (Adenocarcinoma in situ) 或 SCIS (Squamous cell carcinoma in situ)'] 
            },
            { 
                value: 'T1a', 
                label: 'T1a', 
                desc: '腫瘤 ≤ 1 cm', 
                details: ['腫瘤被肺組織或臟層胸膜包圍', '未侵犯主支氣管'] 
            },
            { 
                value: 'T1b', 
                label: 'T1b', 
                desc: '1 cm < 腫瘤 ≤ 2 cm', 
                details: ['腫瘤被肺組織或臟層胸膜包圍', '未侵犯主支氣管'] 
            },
            { 
                value: 'T1c', 
                label: 'T1c', 
                desc: '2 cm < 腫瘤 ≤ 3 cm', 
                details: ['腫瘤被肺組織或臟層胸膜包圍', '未侵犯主支氣管'] 
            },
            { 
                value: 'T2a', 
                label: 'T2a', 
                desc: '3 cm < 腫瘤 ≤ 4 cm', 
                details: [
                '或 侵犯主支氣管 (未及隆突)',
                '或 侵犯臟層胸膜 (Visceral pleura)',
                '或 伴隨肺塌陷/阻塞性肺炎延伸至肺門'
                ] 
            },
            { 
                value: 'T2b', 
                label: 'T2b', 
                desc: '4 cm < 腫瘤 ≤ 5 cm', 
                details: ['具備 T2 的特徵 (如侵犯主支氣管等) 但大小為 4-5cm'] 
            },
            { 
                value: 'T3', 
                label: 'T3', 
                desc: '5 cm < 腫瘤 ≤ 7 cm 或侵犯胸壁/心包膜等', 
                details: [
                '侵犯壁層胸膜 (Parietal pleura)、胸壁 (Chest wall)',
                '侵犯膈神經 (Phrenic nerve)、壁層心包 (Parietal pericardium)',
                '同肺葉內的獨立腫瘤結節 (Separate tumor nodule(s) in same lobe)'
                ] 
            },
            { 
                value: 'T4', 
                label: 'T4', 
                desc: '腫瘤 > 7 cm 或侵犯縱膈/心臟/大血管等', 
                details: [
                '侵犯縱膈、心臟、大血管、氣管、食道、喉返神經、脊椎體、隆突 (Carina)',
                '同側不同肺葉內的獨立腫瘤結節'
                ] 
            }
        ];

        const nOptions = [
            { 
                value: 'Nx', 
                label: 'Nx', 
                desc: '區域淋巴結無法評估',
                details: []
            },
            { 
                value: 'N0', 
                label: 'N0', 
                desc: '無區域淋巴結轉移',
                details: []
            },
            { 
                value: 'N1', 
                label: 'N1', 
                desc: '同側 支氣管周圍/肺門/肺內 淋巴結轉移',
                details: ['包括直接侵犯']
            },
            { 
                value: 'N2a', 
                label: 'N2a', 
                desc: '單一站 (Single Station) 同側 縱膈/隆突下 淋巴結轉移',
                details: ['Ipsilateral mediastinal and/or subcarinal (Single station)']
            },
            { 
                value: 'N2b', 
                label: 'N2b', 
                desc: '多站 (Multiple Stations) 同側 縱膈/隆突下 淋巴結轉移',
                details: ['Ipsilateral mediastinal and/or subcarinal (Multiple stations)']
            },
            { 
                value: 'N3', 
                label: 'N3', 
                desc: '對側 縱膈/肺門，或任何 鎖骨上/斜角肌 淋巴結轉移',
                details: [
                'Contralateral mediastinal/hilar',
                'Ipsilateral or contralateral scalene/supraclavicular'
                ]
            }
        ];

        const mOptions = [
            { 
                value: 'M0', 
                label: 'M0', 
                desc: '無遠處轉移',
                details: []
            },
            { 
                value: 'M1a', 
                label: 'M1a', 
                desc: '胸腔內轉移 (肺/肋膜/心包膜)',
                details: [
                '對側肺葉腫瘤結節 (Contralateral tumor nodules)',
                '惡性肋膜/心包膜積液 (Pleural/pericardial effusion)',
                '肋膜/心包膜結節'
                ]
            },
            { 
                value: 'M1b', 
                label: 'M1b', 
                desc: '單一器官系統的 單一胸腔外轉移',
                details: ['Single extrathoracic metastasis in a single organ system']
            },
            { 
                value: 'M1c1', 
                label: 'M1c1', 
                desc: '單一器官系統的 多發性胸腔外轉移',
                details: ['Multiple extrathoracic metastases in a single organ system']
            },
            { 
                value: 'M1c2', 
                label: 'M1c2', 
                desc: '多重器官系統的 多發性胸腔外轉移',
                details: ['Multiple extrathoracic metastases in multiple organ systems']
            }
        ];

        // --- Logic ---
        const calculateStage = (t, n, m) => {
            if (m === 'M1a' || m === 'M1b') return 'IVA';
            if (m === 'M1c1' || m === 'M1c2') return 'IVB';
            if (t === 'Tx' && n === 'N0' && m === 'M0') return 'Occult Carcinoma';
            if (t === 'Tis' && n === 'N0' && m === 'M0') return '0';

            if (m === 'M0') {
                if (n === 'N0') {
                    if (t === 'T1a') return 'IA1';
                    if (t === 'T1b') return 'IA2';
                    if (t === 'T1c') return 'IA3';
                    if (t === 'T2a') return 'IB';
                    if (t === 'T2b') return 'IIA';
                    if (t === 'T3') return 'IIB';
                    if (t === 'T4') return 'IIIA';
                }
                if (n === 'N1') {
                    if (t.startsWith('T1')) return 'IIA'; 
                    if (t === 'T2a') return 'IIB';
                    if (t === 'T2b') return 'IIB';
                    if (t === 'T3') return 'IIIA';
                    if (t === 'T4') return 'IIIA';
                }
                if (n === 'N2a') {
                    if (t.startsWith('T1')) return 'IIB';
                    if (t === 'T2a') return 'IIIA';
                    if (t === 'T2b') return 'IIIA';
                    if (t === 'T3') return 'IIIA';
                    if (t === 'T4') return 'IIIB';
                }
                if (n === 'N2b') {
                    if (t.startsWith('T1')) return 'IIIA';
                    if (t === 'T2a') return 'IIIB';
                    if (t === 'T2b') return 'IIIB';
                    if (t === 'T3') return 'IIIB';
                    if (t === 'T4') return 'IIIB';
                }
                if (n === 'N3') {
                    if (t.startsWith('T1')) return 'IIIB';
                    if (t === 'T2a') return 'IIIB';
                    if (t === 'T2b') return 'IIIB';
                    if (t === 'T3') return 'IIIC';
                    if (t === 'T4') return 'IIIC';
                }
            }
            return '無法判定';
        };

        // --- Main Component ---
        const StageResult = ({ stage }) => {
            let colorClass = "bg-gray-100 text-gray-800";
            if (stage.startsWith('I') && !stage.startsWith('IV')) colorClass = "bg-green-100 text-green-800 border-green-300";
            else if (stage.startsWith('II') && !stage.startsWith('III')) colorClass = "bg-yellow-100 text-yellow-800 border-yellow-300";
            else if (stage.startsWith('III')) colorClass = "bg-orange-100 text-orange-800 border-orange-300";
            else if (stage.startsWith('IV')) colorClass = "bg-red-100 text-red-800 border-red-300";

            return (
                <div className={`mt-6 p-6 rounded-xl border-2 flex flex-col items-center justify-center text-center transition-all duration-300 ${colorClass}`}>
                    <span className="text-sm font-semibold uppercase tracking-widest mb-1">Calculated Stage (9th Ed.)</span>
                    <span className="text-5xl font-bold">{stage}</span>
                </div>
            );
        };

        function LungCancerStaging() {
            const [t, setT] = useState('T1a');
            const [n, setN] = useState('N0');
            const [m, setM] = useState('M0');
            const [stage, setStage] = useState('');

            useEffect(() => {
                setStage(calculateStage(t, n, m));
            }, [t, n, m]);

            const handleReset = () => {
                setT('T1a');
                setN('N0');
                setM('M0');
            };

            const SelectionGroup = ({ title, icon: Icon, options, selected, onSelect, color }) => (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-6">
                    <div className={`px-4 py-3 border-b border-gray-100 flex items-center gap-2 ${color}`}>
                        <Icon className="w-5 h-5" />
                        <h3 className="font-bold text-lg">{title}</h3>
                    </div>
                    <div className="p-2 grid grid-cols-1 gap-2 max-h-80 overflow-y-auto">
                        {options.map((opt) => (
                        <button
                            key={opt.value}
                            onClick={() => onSelect(opt.value)}
                            className={`
                            relative flex flex-col items-start p-3 rounded-lg border transition-all duration-200 text-left group
                            ${selected === opt.value 
                                ? 'bg-blue-50 border-blue-500 shadow-md transform scale-[1.01] z-10' 
                                : 'bg-white border-gray-100 hover:border-gray-300 hover:bg-gray-50'
                            }
                            `}
                        >
                            <div className="flex w-full justify-between items-center mb-1">
                                <span className={`font-bold text-lg ${selected === opt.value ? 'text-blue-700' : 'text-gray-700'}`}>
                                    {opt.label}
                                </span>
                                {selected === opt.value && <CheckCircle2Icon className="w-5 h-5 text-blue-500" />}
                            </div>
                            <span className={`text-sm leading-snug ${selected === opt.value ? 'text-blue-900 font-medium' : 'text-gray-600'}`}>
                                {opt.desc}
                            </span>
                            {opt.details && opt.details.length > 0 && (
                                <ul className="mt-2 text-xs text-gray-500 list-disc pl-4 space-y-0.5 opacity-80 group-hover:opacity-100 transition-opacity">
                                    {opt.details.map((d, i) => <li key={i}>{d}</li>)}
                                </ul>
                            )}
                        </button>
                        ))}
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-gray-50 p-4 md:p-8 font-sans text-gray-800">
                    <div className="max-w-6xl mx-auto">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                        <div>
                            <h1 className="text-3xl font-extrabold text-gray-900 flex items-center gap-3">
                                <StethoscopeIcon className="w-8 h-8 text-blue-600" />
                                肺癌分期評估工具
                            </h1>
                            <p className="text-gray-500 mt-1 flex items-center gap-2">
                                <ActivityIcon className="w-4 h-4" />
                                依據 IASLC 第 9 版 TNM 分期系統 (2024)
                            </p>
                        </div>
                        <button 
                            onClick={handleReset}
                            className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 hover:text-blue-600 transition-colors shadow-sm"
                        >
                            <RotateCcwIcon className="w-4 h-4" />
                            重置設定
                        </button>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        
                        <div className="lg:col-span-3">
                            <SelectionGroup 
                                title="M - 遠處轉移" 
                                icon={AlertCircleIcon}
                                options={mOptions} 
                                selected={m} 
                                onSelect={setM} 
                                color="text-red-700 bg-red-50"
                            />
                            <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 text-sm text-blue-800">
                                <div className="flex items-start gap-2">
                                    <InfoIcon className="w-4 h-4 mt-0.5 flex-shrink-0" />
                                    <p>
                                        <strong>小提示：</strong> 
                                        如果選擇 M1 (遠處轉移)，分期將直接判定為 IV 期。 M0 則需進一步評估 T 與 N。
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div className="lg:col-span-6 flex flex-col gap-2">
                            <SelectionGroup 
                                title="T - 原發腫瘤" 
                                icon={ActivityIcon}
                                options={tOptions} 
                                selected={t} 
                                onSelect={setT}
                                color="text-blue-700 bg-blue-50" 
                            />
                            <SelectionGroup 
                                title="N - 區域淋巴結" 
                                icon={StethoscopeIcon}
                                options={nOptions} 
                                selected={n} 
                                onSelect={setN}
                                color="text-green-700 bg-green-50" 
                            />
                        </div>

                        <div className="lg:col-span-3">
                            <div className="sticky top-6">
                            <div className="bg-white rounded-xl shadow-lg border border-gray-200 p-5">
                                <h2 className="text-lg font-bold text-gray-800 mb-4 border-b pb-2">評估結果</h2>
                                
                                <div className="space-y-4 mb-6">
                                <div className="flex justify-between items-center text-sm">
                                    <span className="text-gray-500">T (Tumor)</span>
                                    <span className="font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">{t}</span>
                                </div>
                                <div className="flex justify-between items-center text-sm">
                                    <span className="text-gray-500">N (Node)</span>
                                    <span className="font-bold text-green-600 bg-green-50 px-2 py-0.5 rounded">{n}</span>
                                </div>
                                <div className="flex justify-between items-center text-sm">
                                    <span className="text-gray-500">M (Metastasis)</span>
                                    <span className="font-bold text-red-600 bg-red-50 px-2 py-0.5 rounded">{m}</span>
                                </div>
                                </div>

                                <StageResult stage={stage} />

                                <div className="mt-6 text-xs text-gray-400 leading-relaxed text-center">
                                此工具僅供醫療專業人員參考輔助使用，最終診斷請依臨床實際判斷為準。
                                <br/>資料來源：IASLC Staging Project 9th Edition.
                                </div>
                            </div>
                            </div>
                        </div>

                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LungCancerStaging />);
    </script>
</body>
</html>